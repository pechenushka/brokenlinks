// Generated by CoffeeScript 1.3.3
(function() {
  var Links, Loader;

  Links = (function() {

    function Links(options) {
      this.loader = new Loader();
      this.links = [options.url];
      this.status_colors = {
        '200': 'green',
        '404': 'red'
      };
      this.resource_types = options.resource_types;
    }

    Links.prototype.get_links = function(url, parent_url) {
      var resource_types,
        _this = this;
      if (url == null) {
        url = null;
      }
      if (parent_url == null) {
        parent_url = null;
      }
      this.loader.load_show();
      url = url || this.links[0];
      resource_types = this.resource_types;
      return $.get('/get_links/', {
        url: url,
        resource_types: resource_types
      }, function(response) {
        _this.loader.load_hide();
        if (response.error) {
          return Alert.error(response.message);
        } else {
          _this.fill_links(response, url);
          return Alert.success('Связи успешно загружены');
        }
      }).error(function(err) {
        this.loader.load_hide();
        return Alert.error(err.statusText);
      });
    };

    Links.prototype.fill_links = function(links, parent_url) {
      var _this = this;
      if (parent_url == null) {
        parent_url = null;
      }
      return $(links).each(function(key, obj) {
        if ($.inArray(obj.href, _this.links) < 0) {
          _this.links.push(obj.href);
          if ($.inArray(obj.type, _this.resource_types.split(',')) !== -1) {
            obj.color = _this.status_colors[obj.status];
            $("#link_el_template").tmpl(obj).appendTo("#links");
          }
          if (!obj.is_file && obj.status === '200') {
            return _this.get_links(obj.href);
          }
        }
      });
    };

    return Links;

  })();

  Loader = (function() {

    function Loader() {}

    Loader.prototype.load_show = function() {
      $("#loader").show();
      return $("#button_back").hide();
    };

    Loader.prototype.load_hide = function() {
      $("#loader").hide();
      return $("#button_back").show();
    };

    return Loader;

  })();

  window.Links = Links;

  window.Loader = Loader;

}).call(this);
